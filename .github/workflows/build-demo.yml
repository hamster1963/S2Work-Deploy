name: Build and Package to Demo Server

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: write
  pull-requests: write
  packages: write


jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean workspace
        run: |
          if [ -n "$(ls -A ${{ github.workspace }})" ]; then
            rm -rf ${{ github.workspace }}/*
          fi

      - name: Clone from GitLab
        run: |
          git clone --depth 1 --branch master --single-branch ${{ secrets.MAIN_SERVER_REPO }} .

      - name: Setup sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.MAIN_SERVER_PORT }} ${{ secrets.MAIN_SERVER_HOST }} >> ~/.ssh/known_hosts
          # Add demo server host key via jump host
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.MAIN_SERVER_PORT }} root@${{ secrets.MAIN_SERVER_HOST }} "ssh-keyscan -p ${{ secrets.DEMO_SERVER_PORT }} ${{ secrets.DEMO_SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Backup existing Work directory on server
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_DIR="/storage/sites/G2/Page/G2Demo/Work_backup_$TIMESTAMP"
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.MAIN_SERVER_PORT }} root@${{ secrets.MAIN_SERVER_HOST }} "sshpass -p '${{ secrets.DEMO_SSH_PASSWORD }}' ssh -p ${{ secrets.DEMO_SERVER_PORT }} root@${{ secrets.DEMO_SERVER_HOST }} \"if [ -d '/storage/sites/G2/Page/G2Demo/Work' ]; then cp -r '/storage/sites/G2/Page/G2Demo/Work' '$BACKUP_DIR' && echo 'Backup created: $BACKUP_DIR'; else echo 'No existing Work directory to backup'; fi\""

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm install --legacy-peer-deps

      - name: Cache webpack filesystem cache
        uses: actions/cache@v4
        with:
          path: webpack-cache
          key: webpack-cache-${{ runner.os }}-${{ hashFiles('webpack.*.config.js', 'package.json') }}
          restore-keys: |
            webpack-cache-${{ runner.os }}-

      - name: Build project
        run: npm run build

      - name: Create deployment package
        run: |
          tar -czf Work.tar.gz Run/Work/
          FILE_SIZE=$(du -h Work.tar.gz | cut -f1)
          echo "Package created: Work.tar.gz ($FILE_SIZE)"

      - name: Upload Work.tar.gz as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Work.tar.gz
          path: Work.tar.gz
          retention-days: 7

      - name: Upload package to server via jump host
        run: |
          # First upload to main server
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -P ${{ secrets.MAIN_SERVER_PORT }} Work.tar.gz root@${{ secrets.MAIN_SERVER_HOST }}:/tmp/
          # Then transfer from main server to demo server
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.MAIN_SERVER_PORT }} root@${{ secrets.MAIN_SERVER_HOST }} "sshpass -p '${{ secrets.DEMO_SSH_PASSWORD }}' scp -P ${{ secrets.DEMO_SERVER_PORT }} /tmp/Work.tar.gz root@${{ secrets.DEMO_SERVER_HOST }}:/storage/sites/G2/Page/G2Demo && rm -f /tmp/Work.tar.gz"

      - name: Extract package on server
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.MAIN_SERVER_PORT }} root@${{ secrets.MAIN_SERVER_HOST }} "sshpass -p '${{ secrets.DEMO_SSH_PASSWORD }}' ssh -p ${{ secrets.DEMO_SERVER_PORT }} root@${{ secrets.DEMO_SERVER_HOST }} \"cd /storage/sites/G2/Page/G2Demo && rm -rf Work && tar -xzf Work.tar.gz --strip-components=1 && rm -f Work.tar.gz && echo 'Deployment completed successfully'\""
      
      - name: Verify deployment
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.MAIN_SERVER_PORT }} root@${{ secrets.MAIN_SERVER_HOST }} "sshpass -p '${{ secrets.DEMO_SSH_PASSWORD }}' ssh -p ${{ secrets.DEMO_SERVER_PORT }} root@${{ secrets.DEMO_SERVER_HOST }} \"if [ -d '/storage/sites/G2/Page/G2Demo/Work' ]; then echo 'Deployment verified: Work directory exists'; ls -la '/storage/sites/G2/Page/G2Demo/Work' | head -10; else echo 'ERROR: Work directory not found after deployment'; exit 1; fi\""
